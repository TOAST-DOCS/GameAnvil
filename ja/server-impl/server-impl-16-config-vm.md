## Game > GameAnvil > サーバー開発ガイド > サーバー構成と起動

## 構成(Configuration)

GameAnvilは、大きく2つの方法でサーバーを構成できます。最も代表的な方法は、NHN Cloudのコンソールを通じて、駆動するサーバーをGUI上で構成することです。この方法は、クラウド上でVMベースのサービス
またはテストのために使用する方法です。しかし、この方法は開発過程で使用するには煩わしく不便です。そこで、ユーザーが開発中にPCで直接サーバーを構成できるように、GameAnvilConfig.jsonファイルを
提供します。このファイルのデフォルトパスはプロジェクトの resources/ を使用します。もし複数のプロセスでサーバーを構成する場合には、プロセスごとに固有の GameAnvilConfig.json が必要です。

この構成ファイルに入力する値の一部は、サーバーコード上でエンジンに登録する際に使用する値と一致する必要があります。例えば、前述のように構成したGameNodeで使用された"MyGame"というサービス名は
必ずGameAnvilConfig.jsonにも同様に設定されている必要があります。そうでない場合、該当サービスが見つからず、サーバー起動プロセスでエラーが発生します。

```java

var gameServiceBuilder = gameAnvilServerBuilder.createGameService("MyGame");
gameServiceBuilder.gameNode(SampleGameNode::new, config -> {
    // ここにハンドラを追加します 
});

```

それでは、これらの内容を一度確認してみましょう。

## GameAnvilConfig.json編集

GameAnvilConfigは、サーバーを柔軟に構成するために非常に多数の設定を提供します。大部分はエンジンのデフォルト値で十分なため、ここではユーザーの理解が必要な設定値のみ説明します。大きく5つに
分けられます。

### 共通設定(common)

ノード構成に関係なく、必須の共通情報を設定します。

```json
"common": {
  "ipcIp": "127.0.0.1",                 // 内部ネットワーク同士で通信するIP。(マシンのIPを指定)
  "meetEndPoints": ["127.0.0.1:18000"], // 対象ノードのcommon IPとipcPort登録。(該当サーバーのendpointを含めることが可能、リストで複数指定可能)
  "debugMode": false                    // デバッグ時に各種timeoutが発生しないようにするオプション。本番環境では必ずfalseにする必要あり
},
```

各構成項目の説明は次のとおりです。

| 名前           | 説明                                                                         | デフォルト値      |
|----------------|------------------------------------------------------------------------------|------------|
| icpIp          | ノードごとに共通で使用するIPであり(マシンのIPを指定)、値がない場合はprivate ipに自動指定されます。                                                | -          |
| meetEndPoints  | 対象ノードのicpIpとipcPortを登録します。<br />該当サーバーのendpointを含めることが可能で、リストで複数登録可能です。 | -          |
| debugMode      | デバッグ時に各種timeoutが発生しないようにするオプションで、**サービス時には必ずfalseにする必要があります。** | false      |

### location

実はロケーションノードは、サーバー全体のユーザーとルームの位置情報を担当するシステムノードです。エンジンが管理して直接使用する用途なので、ユーザーが追加の実装を行う必要はありません。しかし、このようなシステムノードもいくつの
ノードで構成するかはユーザーの選択次第であるため、別途の構成方法を提供します。開発過程では、以下の使用例をそのまま使用しても構いません。一方、実際のサービスのための構成は、ゲームのコンテンツやボリュームに合わせて適切に
適用する必要があるため、GameAnvil担当者と別途協議を行うことを推奨します。各設定項目は以下のとおりです。

```json
"location": {
  "clusterSize": 1, // 合計いくつのマシン(VM)で構成されるか？ [1 ～ 5]
  "replicaSize": 1, // レプリケーショングループのサイズ (master + slaveの個数) [2 ～ 5]
  "shardFactor": 2  // shardingのための引数 [2 ～ 5]
},
```

> [参考]
>
> 該当設定(location)のキー値がないか、clusterSizeが0の場合、該当プロセスでロケーションノードを生成しません。


各構成項目の説明は次のとおりです。

| 名前        | 説明                                                                                                                                                                                                                    | デフォルト値 |
|-------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-----|
| clusterSize | 構成されるサーバーの数(VM)を設定します。                                                                                                                                                                                                                                                                                                         | 0   |
| replicaSize | 複製グループのサイズ( master + slave )の個数を設定します。                                                                                                                                                                                                                                                                                       | 0   |
| shardFactor | shardingのための引数を設定します。 <br />-全shardの個数 = clusterSize x replicaSize x shardFactor <br />-1つのマシン(VM)で駆動するshardの個数 = replicaSize x shardFactor < br />-固有shardの総数(masterシャードの個数) = clusterSize x shardFactor | 0   |

### Location Cluster

masterロケーションノードにリクエストして、ユーザーやルームなどの位置情報を照会できます。ただし、全てのロケーションノードのクラスタリングが完了した後でのみリクエストを送信できます。ロケーションノードを使用するように設定した場合
エンジン内部ではロケーションノードを駆動し、全てのロケーションノードのクラスタリングが完了したかチェックします。一定時間内に全体のクラスタリングが完了しない場合、エラーログを残します。

### Location Fail-over

replicaSizeを2以上に設定する場合、masterロケーションノードとslaveロケーションノードが存在することになります。もしmasterロケーションノードが停止した場合、slaveロケーションノードがmasterの
役割を代替するようにlocation fail-over機能が実装されています。masterロケーションノードがあったサーバーを再起動する場合には、VmOptionに `-DrestartedAfterDown=true` を
追加して区別できるようにします。このとき再起動されるロケーションノードは全てslaveとして駆動します。

### match

マッチノードはマッチメイキングを実行するノードです。つまり、ユーザーが実装したマッチメーカーを駆動します。このようなマッチノードは、いくつのノードを駆動するかだけを決定すれば良いです。一般的な開発過程や小規模なサービスでは、1つの
マッチノードでも十分です。

```json
"match": {
  "nodeCnt": 1 // [0 ~ 99]
},
```

> [参考]
>
> 該当設定(match)のキー値がないか、nodeCntが0の場合、該当プロセスでマッチノードを生成しません。

各構成項目の説明は次のとおりです。

| 名前      | 説明                                                 | デフォルト値 |
|-----------|------------------------------------------------------|-----|
| nodeCnt   | マッチノードの個数を設定します。 <br /> 0の場合、マッチノードを生成しません。   | 0   |

### gateway

ゲートウェイノードはクライアントが接続を結ぶノードです。そのため、接続するクライアントの規模に合わせて適切な数のノードを準備する必要があります。

```json
"gateway": {
  "connectGroup": {   // コネクションの種類。
    "TCP_SOCKET": {
      "port": 18200   // クライアントと接続されるポート。[1 ～ 66535]
    }
  },
  "nodeCnt": 4,       // ノード数。(ノード番号は0から付与される) [0 ～ 99]
  "duplicateLoginServices": {
    "MyGame": ["MyChatting"]
  }
},
```

> [参考]
>
> 該当設定(gateway)のキー値がないか、nodeCntが0の場合、該当プロセスでゲートウェイノードを生成しません。

各構成項目の説明は次のとおりです。

| 名前                     | 説明                                                    | デフォルト値 |
|--------------------------|---------------------------------------------------------|------|
| connectGroup               | ゲートウェイノードは"TCP_SOCKET"と"WEB_SOCKET"ソケットをサポートします。          | -    |
| connectGroup : port      | クライアントが接続するポートを指定します。                                   | 0    |
| nodeCnt                   | ゲートウェイノードの個数を設定します。 <br /> 0の場合、ゲートウェイノードを生成しません。 | 0    |
| duplicateLoginServices   | 重複ログイン可能サービスを設定します。                                   | -    |

### game

ゲームノードは、実際のゲーム関連オブジェクトが生成され、コンテンツがプレイされるノードです。ゲームコンテンツの特性に合わせてノード数やチャンネルなどを構成できます。

```json
"game": [
  {
    "serviceId": 1,           // サーバー群で一意である必要あり [0 ～ 99]
    "serviceName": "MyGame",  // サーバー群でユニークである必要があります
    "nodeCnt": 4,             // ノード数。nodeCntが0の場合、Game Nodeを生成しません。マシンのコア数で設定することを推奨 [0 ～99]
    "channelIDs": [
      ["初心者"],
      ["中級者"],
      ["初心者"],
      ["中級者"]
    ],                        // ノードごとに付与するチャネルID。(ユニークでなくても可。""という文字列でチャネルを区別せずに重複使用も可能)
    "userTimeout": 5000       // 切断後のユーザーオブジェクト削除タイムアウト。[0 ～ 604800000(7日)]
  }
],
```


> [参考]
>
> サービス名は、必ずサーバーコード上でユーザーが作成したゲームノードクラスをエンジンに登録するために使用したサービス名を入力する必要があります。次はゲームノードに関する例です。「MyGame」という
> サービス名を使用しました。
>
> ```java
> var gameServiceBuilder = gameAnvilServerBuilder.createGameService("MyGame");
> gameServiceBuilder.gameNode(SampleGameNode::new, config -> {
>    // ここにハンドラを追加します
> });
> ```
>
> そのため、必ずGameAnvilConfigで次のようにサービス名を"MyGame"に設定する必要があります。次の例は"MyGame"サービス名をサービスID "1"にマッピングした例です。このサービス名とサービス
> IDは、全体の構成で一意の値である必要があります。
>
> ```json
> "game": [
>   {
>     "serviceId": 1,            // サーバー群で一意である必要あり [0 ～ 99]
>     "serviceName": "MyGame",  // サーバー群で一意である必要があります
>     "nodeCnt": 4,              // ノード数。nodeCntが0の場合、Game Nodeを生成しません。マシンのコア数で設定することを推奨 [0 ～99]
>     "channelIDs": [
>        ["初心者"],
>        ["中級者"],
>        ["初心者"],
>        ["中級者"]
>      ],                             // ノードごとに付与するチャンネルID。(一意でなくても良い。""文字列でチャンネル区別なく重複使用も可能)
>      "userTimeout": 5000        // 切断後のユーザーオブジェクト削除タイムアウト。[0 ～ 604800000(7日)]
>   },
>   {
>     "serviceId": 2,             // サーバー群で一意である必要あり [0 ～ 99]
>     "serviceName": "MyChatting",// サーバー群で一意である必要があります
>      "nodeCnt": 1,                // ノード数。nodeCntが0の場合、Game Nodeを生成しません。マシンのコア数で設定することを推奨 [0 ～99]
>      "channelIDs": [[""]],        // ノードごとに付与するチャンネルID。(一意でなくても良い。""文字列でチャンネル区別なく重複使用も可能)
>      "userTimeout": 5000          // 切断後のユーザーオブジェクト削除タイムアウト。[0 ～ 604800000(7日)]
>   }
> ],
> ```
>
> 上記の構成例は、追加でMyChattingサービスを示しています。サービスIDは「MyGame」とは異なる「2」であることが確認できます。

> [参考]
>
> 該当設定のように、基本的にチャンネル設定はスレッド1つにつきゲームノード1つの設定を行います。
>
> チャンネルを多く使用する場合、そのうちいくつかのチャンネルにのみユーザーが集中すると、多くのスレッドによって性能低下が発生する可能性があります。そのため、1つのスレッドに複数のゲームノード設定をサポートしています。
> 
> ```json
> "game": [
>   {
>     "serviceId": 1,            // サーバー群で一意である必要あり [0 ～ 99]
>     "serviceName": "MyGame",  // サーバー群で一意である必要があります
>     "nodeCnt": 4,              // ノード数。nodeCntが0の場合、Game Nodeを生成しません。マシンのコア数で設定することを推奨 [0 ～99]
>     "channelIDs": [
>       ["初心者", "中級者"], // スレッド1
>       ["上級者"]          // スレッド2
>      ],                             // ノードごとに付与するチャンネルID。(一意でなくても良い。""文字列でチャンネル区別なく重複使用も可能)
>      "userTimeout": 5000        // 切断後のユーザーオブジェクト削除タイムアウト。[0 ～ 604800000(7日)]
>   }
> ],
>```
> ゲームノード: 計3つ (nodeCnt値は無視)
> 
> ゲームノードスレッド: 計2つ
> 
> スレッド1: ゲームノード1("初心者")、ゲームノード2("中級者")
> 
> スレッド2: ゲームノード3("上級者")

> [参考]
>
> 該当設定("game")のキー値がないか、nodeCntが0の場合、該当プロセスでゲームノードを生成しません。

各構成項目の説明は次のとおりです。

| 名前        | 説明                                                                                                                                                                                                                                                     | デフォルト値 |
|-------------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|------|
| serviceId   | サービスIDとして、サーバー構成全体で一意の数値である必要があります。<br/>ただし、0 ～ 99の間の値のみ使用可能です。                                                                                                                                                                                                                                                                     | 0    |
| serviceName | サービス名であり、全体サーバー構成で一意の文字列である必要があります。<br/>このサービス名はゲームノードをエンジンに登録するために使用されます。 | |
| nodeCnt     | ゲームノードの個数を設定します。 <br /> 0の場合、ゲームノードを生成しません。                                                                                                                                                                                                                                                                                                      | 0    |
| channelIDs  | ノードごとに付与するチャンネルIDであり、一意の値である必要はありません。<br>ただし、""はチャンネルを使用しないことを意味します。                                                                                                                                                                                                                                                                             |      |
| userTimeout | 切断後のユーザーオブジェクト削除タイムアウト時間(ms)を設定します。<br/>User状態が切断されてからUserオブジェクトが生存する時間で、該当時間が過ぎる前に再接続されない場合、logout処理されてUserオブジェクトが削除されます。<br/>クライアントの接続切れ後、ユーザーオブジェクトをサーバーから削除せずに、どの程度の間管理するかを設定します。<br/>0の場合、Userオブジェクトは維持されずに即座に削除されます。  | 0    |

### support

サポートノードは補助的な役割を遂行するノードです。クライアントとの直接通信も可能なので、ゲームに関連する情報を交換したり、定期的な操作、あるいはゲーム外で独立した実装が必要な操作などを委任して処理するのに
適しています。

```json
"support": [
  {
    "serviceId": 3,       // [0 ~ 99]
    "serviceName": "DB",
    "nodeCnt": 2,         // [0 ~99]
    "restIp": "127.0.0.1",
    "restPort": 18611     // REST接続ポート。[ 0 ～ 65535]
  },
  {
    "serviceId": 4,
    "serviceName": "SampleWebSupport",
    "nodeCnt": 2,
    "restPort": 18612
  }
},
```

> [参考]
>
> 前述のゲームノードと同様に、サーバーコード上でユーザーが作成したサポートノードクラスをエンジンに登録するために使用したサービス名は、この設定で必ず入力する必要があります。

> [参考]
>
> 該当設定("support")のキー値がないか、nodeCntが0の場合、該当プロセスでサポートノードを生成しません。

各構成項目の説明は次のとおりです。

| 名前        | 説明                                                                      | デフォルト値 |
|-------------|---------------------------------------------------------------------------|-----|
| serviceId   | サービスIDとして、サーバー構成全体で一意の数値である必要があります。<br/>ただし、0 ～ 99の間の値のみ使用可能です。      | 0   |
| serviceName | サービス名であり、全体サーバー構成で一意の文字列である必要があります。<br/>このサービス名はサポートノードをエンジンに登録するために使用されます。 | - |
| nodeCnt     | サポートノードの個数を設定します。 <br /> 0の場合、サポートノードを生成しません。                       | 0   |
| restIp      | RESTfulリクエストのためのIPアドレスを指定します。<br/>(設定値がない場合は、該当マシンのプライベートIPに自動指定)       | -   |
| restPort    | RESTfulリクエストのためのポートを指定します。                                                              | 0   |

## VMオプション

GameAnvilサーバーの起動のために開発チームで使用しているVMオプションの核心的な部分を共有します。ここで推奨するVMオプションは、これまで数回の大規模性能テストを通じて検証されました。これを参考に、ユーザーが
適宜変更しながら使用してください。

### 推奨VMオプション

* JVMのメモリサイズはシステムに合わせて設定します。参考までに、開発チームは8GBマシンでは4～6GBを、16GBマシンでは10～12GBを使用します。
* GameAnvilはG1GCを公式GCとして使用します。そのため、特別な理由がなければG1GCの使用を推奨します。
* GCログのための最小限のオプションを追加することを強く推奨します。特に、開発過程では必須です。

#### Java 21

```
--add-opens java.base/java.lang=ALL-UNNAMED
--add-opens java.base/java.lang.invoke=ALL-UNNAMED 
-Xms6g
-Xmx6g
-XX:MaxGCPauseMillis=100
-XX:+UseStringDeduplication

-Xloggc:gc.log
```

* 1行目の `--add-opens java.base/java.lang=ALL-UNNAMED` 構文は、GameAnvilで仮想スレッドをカスタムして使用しているために必要なjvmオプションです。
  この設定を削除した場合、正常に動作しない可能性があります。
* 2行目の `--add-opens java.base/java.lang.invoke=ALL-UNNAMED` 構文は、GameAnvilでのリフレクション性能最適化のための構文です。このオプションを削除しても起動することは
  できますが、性能が低下する可能性があります。

### GCログのためのVMオプション

GCログのためのオプションは、メモリリークなどを追跡するために必須です。そのため、特別な理由がない限り、少なくとも開発過程では次のようなGCログ関連オプションを追加することを推奨します。しかし、実際のサービスでは性能に
影響を与える可能性があるため、一部の最適化されたオプションのみ必要に応じて追加する必要がある場合もあります。先ほど推奨したオプションに加え、各Javaバージョンに応じて次のようなオプションを追加できます。

#### Java 21

```
-Xlog:gc*,safepoint:YOUR_PATH/gc.log:time,level,tags,uptime
```

次のようにファイルローテーションオプションを追加することもできます。

```
-Xlog:gc*,safepoint:YOUR_PATH/gc.log:time,level,tags,uptime:filecount=100,filesize=10M
```
