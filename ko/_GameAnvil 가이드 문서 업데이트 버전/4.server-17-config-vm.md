## Game > GameAnvil > 서버 개발 가이드 > 설정 및 구동

## 1. 개발 서버 띄우기

개발 중에 노드 단위로 서버를 구성해서 구동하기 까지의 흐름 설명하자.



## 11. Configurations

GameAnvil은 GameAnvilConfig.json 파일을 통해 서버 구성을 변경할 수 있습니다. 이러한 구성 파일은 총 7개의 항목으로 분류되며 common을 제외하면 각각 한 종류의 노드를 설정합니다. 이때, 설정하는 값 중 일부는 Bootstrap 단계에서 사용하는 값과 일치해야 합니다. 예를 들면 앞서 우리는 아래와 같이 GameNode를 구성했습니다. 여기에 사용된 ServiceName인 "SampleGameService"는 반드시 GameAnvilConfig.json에 설정되어 있어야 합니다. 그렇지 않으면 해당 서비스를 찾지 못하여 서버 구동 과정에서 오류가 발생합니다.

```
bootstrap.setGame("SampleGameService")
            .node(SampleGameNode.class)
```



### common

- 필수적인 공통 설정

| 이름                            | 설명                                                         | 기본값  |
| ------------------------------- | ------------------------------------------------------------ | ------- |
| vmId                            | 하나의 machine에서 여러 개의 JVM을 띄울 경우 사용하는 고유식별 ID ( 0 <= vmId < 100) | 0       |
| ip                              | 노드마다 공통으로 사용하는 IP. (머신의 IP를 지정) 값이 없을 경우 private ip로 자동 지정된다. |         |
| meetEndPoints                   | 대상 노드의 common IP와 communicatePort 등록 해당 서버 endpoint 포함 가능 리스트로 여러 개 등록 가능 |         |
| keepAliveTime                   | communicateNode 연결 지속 시간 (ms)                          | 60000   |
| nodeTimeout                     | 노드 상태 체크 타임아웃(ms) 0이면 체크하지 않음.             | 180000  |
| msgExpiredTime                  | 메시지 만료 시간                                             | 30000   |
| defaultReqTimeout               | 노드간 메시지 라우팅 타임아웃(ms)0이면 체크하지 않음.        | 30000   |
| defaultAsyncAwaitTimeout        | 블로킹 호출 시 타임아웃(ms)                                  | 30000   |
| ipcPort                         | 다른 ipc node 와 통신할때 사용되는 포트                      | 11100   |
| publisherPort                   | publish socket을 위한 포트                                   | 11101   |
| debugMode                       | 디버깅 시 각종 timeout 이 발생안하도록 하는 옵션리얼에서는 반드시 false 이어야 한다. | false   |
| nodeInfoUpdateTime              | JVM에 있는 노드 정보를 다른 JVM에게 전파하는 주기            | 500(ms) |
| nodeInfoUpdateBusyTime          | 노드 정보가 업데이트될 때 이 시간보다 오래 걸렸을 경우 해당 노드는 BUSY 상태라고 판단함. | 510(ms) |
| nodeInfoManagerRefreshTime      | 전달받은 노드 정보를 이용해 NodeInfoManager를 갱신하는 주기. | 100(ms) |
| loopInfoSamplingCount           | Message Loop의 상태를 체크할 때 Sampling할 loop 횟수         | 100(회) |
| enableLoopInfoMonitor           | NodeInfoPage에서 loop 정보 갱신 여부                         | true    |
| maxUserCount                    | IdleNode 판단 시 idle로 판단할 최대 User 수                  | 2500    |
| addLocWeight                    | UserLoc 할당 시 정보 보정을 위해 사용할 배수. 예) 게임 노드가 8개일 경우 1명이 할당되었지만 8명의 유저가 할당되었다고 임의로 지정. | 1       |
| allocatorType                   | 사용할 bytebuf type 1 (POOLED_DIRECT_BUFFER) 2 (POOLED_HEAP_BUFFER) 3 (UNPOOLED_DIRECT_BUFFER) 4 (UNPOOLED_HEAP_BUFFER) | 4       |
| httpClientOption                | Gameflex에서 사용하는 httpClientOption                       |         |
| httpClientOption-keepAlive      | httpClientOption 연결 지속 여부                              | true    |
| httpClientOption-connTimeout    | httpClientOption connection 타임아웃                         | 5000    |
| httpClientOption-requestTimeout | httpClientOption  request 타임아웃                           | 10000   |
| httpClientOption-maxConnPerHost | httpClientOption host당 최대 connection 개수                 | 10000   |
| httpClientOption-maxConn        | httpClientOption connection 최대 개수                        | 12000   |
| moduleURL                       | config, dynamicModule 정보를 읽어올 URL 정보 해당 옵션이 설정될 경우 URL을 사용해서 module 정보를 불러온다. | ""      |
| configPath                      | config를 File로 읽어올 시 config의 Json 파일을 읽어올 경로 moduleURL이 설정될 경우 무시 | /config |

- 사용 예시

```
"common": {
    "ip": "127.0.0.1",
    "meetEndPoints": ["127.0.0.1:16000"],
    "keepAliveTime": 10000,
    "nodeTimeout": 180000,
    "msgExpiredTime:":30000,
    "defaultReqTimeout": 30000,
    "defaultAsyncAwaitTimeout": 30000,
    "communicatePort": 16000,
    "publisherPort" : 13300,
    "debugMode": false,
    "allocatorType": 1,
    "nodeInfoUpdateTime": 10,
    "nodeInfoUpdateBusyTime": 12,
    "nodeInfoManagerRefreshTime": 4,
    "loopInfoSamplingCount": 5,
    "maxLoopTime" : 10,
    "enableLoopInfoMonitor" : true,
    "maxUserCount" : 2500,
    "addLocWeight": 16,
    "httpClientOption": {
        "keepAlive": true,
        "connTimeout": 5000,
        "requestTimeout": 10000,
        "maxConnPerHost" : 10000,
        "maxConn": 12000
    }
},
```



### location

- 설정값이 없거나 clusterSize가 0이면 LocationNode를 생성하지 않습니다.

| 이름        | 설명                                                         | 기본값 |
| ----------- | ------------------------------------------------------------ | ------ |
| clusterSize | 구성되는 서버의 수(VM)                                       |        |
| replicaSize | 복제 그룹의 크기 master + slave의 개수                       |        |
| shardFactor | sharding을 위한 인수 <br />-전체 shard의 개수 = clusterSize x replicaSize x shardFactor <br />-하나의 머신(VM)에서 구동할 shard의 개수 = replicaSize x shardFactor <br />-고유한 shard의 총 개수 (master 샤드의 개수) = clusterSize x shardFactor |        |

- 사용 예시

```
"location": {
    "clusterSize": 1,
    "replicaSize": 3,
    "shardFactor": 3
},
```



### match

- 설정값이 없거나 nodeCnt가 0이면 MatchNode를 생성하지 않습니다.

| 이름    | 설명            | 기본값 |
| ------- | --------------- | ------ |
| nodeCnt | match node 개수 |        |

- 사용 예시

```
"match": {
    "nodeCnt": 3
},
```



### gateway

- 설정값이 없거나 nodeCnt가 0이면 GatewayNode를 생성하지 않습니다.

| 이름                                     | 설명                                                         | 기본값 |
| ---------------------------------------- | ------------------------------------------------------------ | ------ |
| nodeCnt                                  | 노드 개수                                                    |        |
| ip                                       | 클라이언트와 연결되는 IP 설정값이 없을 경우 private ip로 자동 설정 |        |
| dns                                      | 클라이언트와 연결되는 도메인 주소                            |        |
| maintenance                              | 서버 시작 시 점검 여부                                       | false  |
| checkWhiteListBeforeOnAuth               | onAuthenticate 콜백 호출 전 WhiteList 체크 여부              | true   |
| connectGroup                             | TCP_SOCKET WEB_SOCKET                                        |        |
| connectGroup - port                      | 클라이언트와 연결되는 포트                                   |        |
| connectGroup - idleClientTimeout         | 데이터 송수신이 없는 상태 이후의 타임아웃.0 이면 사용하지 않음 | 4000   |
| connectGroup - secure                    | 보안 설정 설정값이 없을 경우 사용하지 않음.                  |        |
| connectGroup - secure - useSelf          | keyCertChainPath, privateKeyPath 설정값과 상관없이 보안 설정 사용여부 | false  |
| connectGroup - secure - keyCertChainPath | 인증서 경로 <br />-Dsecure 설정 경로에서 시작됨              |        |
| connectGroup - secure - privateKeyPath   | 개인키 경로 <br />-Dsecure 설정 경로에서 시작됨              |        |
| duplicateLoginServices                   | 중복 로그인 가능 서비스 지정                                 |        |

- 사용 예시

```
"gateway": {
    "nodeCnt": 4,
    "ip": "127.0.0.1",
    "dns": "",
    "maintenance": false,
    "checkWhiteListBeforeOnAuth": true,
    "connectGroup": {
        "TCP_SOCKET": {
            "port": 11200,
            "idleClientTimeout": 0,
            "secure": {
                "useSelf": true,
                "keyCertChainPath": "gameflex.crt",
                "privateKeyPath": "privatekey.pem"
            }
        },
        "WEB_SOCKET": {
            "port": 11400,
            "idleClientTimeout": 0
        }
    },
    "duplicateLoginServices": {
        "RPSGame": ["GroupChatting"],
        "GroupChatting": ["SampleGameService"],
        "ForTestCase": []
    }
},
```



### game

- 설정값이 없거나 nodeCnt가 0이면 GameNode를 생성하지 않습니다. 앞서 설명했듯이 엔진의 Bootstrap 단계에서 사용한 ServiceName을 이 곳에 설정해야 합니다.

| 이름        | 설명                                                         | 기본값 |
| ----------- | ------------------------------------------------------------ | ------ |
| nodeCnt     | 노드 개수                                                    |        |
| serviceId   | Service ID                                                   |        |
| serviceName | Service 이름                                                 |        |
| channelIDs  | 노드마다 부여할 채널 ID. 유니크하지 않아도 됨, "" 문자열로 채널 구분없이 중복사용도 가능 |        |
| userTimeout | disconnect 이후의 유저객체 제거 타임아웃                     | 10000  |

- 사용 예시

```
"game": [
    {
        "nodeCnt": 8,
        "serviceId": 0,
        "serviceName": "SampleGameService",
        "channelIDs": ["ch1","ch1","ch2","ch2","ch3","ch3","ch4","ch4"],
        "userTimeout": 3000
    },
    {
        "nodeCnt": 4,
        "serviceId": 1,
        "serviceName": "GroupChatting",
        "channelIDs": ["", "", "", ""],
        "userTimeout": 4000
    }
],
```



### support

- 설정값이 없거나 nodeCnt가 0이면 SupportNode를 생성하지 않습니다. SupportNode도 GameNode와 마찬가지로 Bootstrap 단계에서 사용한 ServiceName이 반드시 설정되어야 합니다.

| 이름                             | 설명                                                         | 기본값 |
| -------------------------------- | ------------------------------------------------------------ | ------ |
| nodeCnt                          | 노드 개수                                                    |        |
| serviceId                        | service ID                                                   |        |
| serviceName                      | service 이름                                                 |        |
| restIp                           | rest ip 설정값이 없을 경우 private ip로 자동 설정            |        |
| restPort                         | rest port                                                    |        |
| restPermissionGroups             | ACL 설정 허용할 특정 Path와 IP를 등록. 비어 있을 경우 모든 접속 허용 |        |
| restSecure                       | 설정값이 없을 경우 사용하지 않음                             |        |
| restSecure - keyCertChainPath    | 인증서 경로 -Dsecure 설정 경로에서 시작됨                    |        |
| restSecure - privateKeyPath      | 개인키 경로 -Dsecure 설정 경로에서 시작됨                    |        |
| restSecure - authorizationSecret | 인증토큰(JWT) 사용하는 경우만 필요, 암호화 시그니처 키       |        |
| restSecure - authorizationPath   | 인증토큰(JWT) 사용하는 경우만 필요, 인증을 진행할 경로       |        |
| restCorsAllowDomains             | CORS 허용 domain 예-127.0.0.1:1234                           |        |

- 사용 예시

```
"support": [
    {
        "nodeCnt": 2,
        "serviceId": 3,
        "serviceName": "PLACE",
        "restIp": "127.0.0.1",
        "restPort": 17260,
        "restPermissionGroups": {
            "/": []
        },
        "restSecure": {
            "keyCertChainPath": "",
            "privateKeyPath": "",
            "authorizationSecret": "authSecret",
            "authorizationPath": "/auth"
        },
        "restCorsAllowDomains":[
        ]
    },
    {
        "nodeCnt": 2,
        "serviceId": 4,
        "serviceName": "DB",
        "restIp": "127.0.0.1",
        "restPort": 17251,
        "restPermissionGroups": {
            "/": []
        }
    },
    {
        "nodeCnt": 2,
        "serviceId": 5,
        "serviceName": "SampleWebSupport",
        "restIp": "127.0.0.1",
        "restPort": 17250
    }
],
```



### management

- 설정값이 없거나 nodeCnt가 0이면 ManagementNode를 생성하지 않습니다.

| 이름          | 설명                                                         | 기본값                          |
| ------------- | ------------------------------------------------------------ | ------------------------------- |
| nodeCnt       | 노드 개수                                                    |                                 |
| restIp        | rest ip 설정값이 없을 경우 private ip로 자동 설정            |                                 |
| restPort      | rest port                                                    |                                 |
| db            | management에서 사용하는 db 설정                              |                                 |
| db - user     | db 접속 ID                                                   |                                 |
| db - password | db 접속 비밀번호                                             |                                 |
| db - url      | db 접속 url - h2db : jdbc:h2:mem:gameflex_admin;DB_CLOSE_DELAY=-1 - mysql : jdbc:mysql://localhost:3306/gameflex_admin?useSSL=false - mariadb : jdbc:mariadb://localhost:3306/gameflex_admin?useSSL=false |                                 |
| db - driver   | db 접속 driver- h2db : org.h2.Driver- mysql : com.mysql.jdbc.Driver- mariadb : org.hibernate.dialect.MySQLDialect | org.h2.Driver                   |
| db - dialect  | db 접속 dialect- h2db : org.hibernate.dialect.H2Dialect- mysql : org.hibernate.dialect.MySQLDialect- mariadb : org.hibernate.dialect.MySQLDialect | org.hibernate.dialect.H2Dialect |
| db - ddlAuto  | ddl 옵션 - update : 자동으로 Table 생성 - none : 자동으로 Table을 생성하지 않음. | update                          |

- 사용 예시

```
"management": {
    "nodeCnt": 2,
    "restIp": "127.0.0.1",
    "restPort": 25150,

    "db": {
        "user": "root",
        "password": "1234",
        "url": "jdbc:h2:mem:gameflex_admin;DB_CLOSE_DELAY=-1"
    }
}
```

