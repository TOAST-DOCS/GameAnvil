## ConnectionAgent

ConnectionAgent는 GameAnvil 서버의 커넥션 노드와 관련된 작업을 담당합니다. 접속(Connect()), 인증(Authentication()) 등 기본 세션 관리 기능 및 채널 목록 등을 제공하며, 직접 정의한 프로토콜을 기반으로 여러 가지 컨텐츠를 구현할 수 있습니다. ConnectionAgent는 커넥터가 초기화될 때 자동으로 생성되며 Connector.GetConnectionAgent() 함수를 이용해 얻을 수 있습니다.

```c#
ConnectionAgent connectionAgent = connector.GetConnectionAgent();
```

### 서버 접속

ConnectionAgent의 Connect 함수를 이용해 서버에 접속합니다. 

```c#
/// <param name="ip">ip address</param>
/// <param name="port">port</param>
/// <param name="onConnect">결과를 전달 받을 delegate</param>
connector.GetConnectionAgent().Connect(ip, port, (ConnectionAgent connectionAgent, ResultCodeConnect result) => {
    /// <param name="result">Connect의 결과</param>
    if (result == ResultCodeConnect.CONNECT_SUCCESS) {
		// 접속 성공
    } else {
	    // 접속 실패
    }
});
```

### 인증

ConnectionAgent의 Authenticate 함수를 이용해 인증절차를 진행합니다. 인자로 deviceId, accountId, password, payload, 응답을 처리할 콜백을 넘겨줍니다. deviceId는 중복 접속에 대한 처리에 활용되며, accountId와 password를 활용하여 서버에서 인증 처리를 할 수 있습니다. 인증을 위해 deviceId, accountId, password 외의 추가 정보가 필요할 경우 payload에 담아 보낼수 있으며 사용하지 않을 경우 payload 인자는 생략할 수 있습니다.  
Authenticate 함수를 호출하면 서버에서는 BaseConnection의 onAuthentication() 콜백이 호출되며 이 콜백의 처리 결과로 인증의 성공, 실패가 결정됩니다.

```c#
/// <param name="deviceId">사용자 기기를 식별 할 수 있는 고유 ID.서버 구현에 따라 사용하지 않을 수 있음.</param>
/// <param name="accountId">사용자 계정을 식별 할 수 있는 고유 ID.</param>
/// <param name="passwd">사용자 계정의 password. 서버 구현에 따라 사용하지 않을 수 있음.</param>
/// <param name="payload">추가 정보. 서버 구현에 따라 사용하지 않을 수 있음.</param>
/// <param name="onAuthentication">결과를 전달 받을 delegate</param>
connector.GetConnectionAgent().Authenticate(deviceId, accountId, password, payload
         (ConnectionAgent connectionAgent, ResultCodeAuth result, List<ConnectionAgent.LoginedUserInfo> loginedUserInfoList, string message, Payload payload) => {
	/// <param name="result">Authentication의 결과</param>
    /// <param name="loginedUserInfoList">서버에 남아있는 로그인 정보 목록</param>
    /// <param name="message">서버로부터 받은 Message. 인증 실패 이유 등.</param>
    /// <param name="payload">추가 정보</param>
    if (result == ResultCodeAuth.AUTH_SUCCESS) {
		// 인증 성공
    } else {
		// 인증 실패
    }
});
```

### 채널 정보

GameAnvil은 설정으로 자유롭게 채널을 구성할 수 있습니다. 이런 채널구성은 서버와 클라이언트간에 미리 약속하여 고정된 형태로 사용할 수도 있지만, 상황에 따라 다양하게 변경하여 사용할 수도 있습니다. ConnectionAgent에서는 이렇게 변경된 채널 정보를 얻어올 수 있도록 몇가지 함수를 제공합니다. 

GetChannelList()는 특정 서비스의 채널 아이디 목록을 요청하여 받아올 수 있습니다. 

```c#
/// <param name="serviceName">채널 정보를 요청할 서비스의 serviceName.</param>
/// <param name="onChannelList">결과를 전달 받을 delegate.</param>
connector.GetConnectionAgent().GetChannelList(serviceName, (ConnectionAgent connection, ResultCodeChannelList result, List<string> channelIdList) => {
    /// <param name="result">GetChannelList의 결과</param>
	/// <param name="channelIdList">채널 목록</param>
	if(result == ResultCodeChannelList.CHANNEL_LIST_SUCCESS){
		// 채널 목록 요청 성공
	} else {
		// 채널 목록 요청 실패
	}
});
```

GetChannelCountInfo()는 특정 채널의 카운트 정보(유저와 방 개수)를 요청하여 받아올 수 있습니다. 

```c#
/// <param name="serviceName">채널 정보를 요청할 서비스의 serviceName.</param>
/// <param name="channelId">채널 정보를 요청할 채널의 ChannelId.</param>
/// <param name="onChannelInfo">결과를 전달 받을 delegate.</param>
connector.GetConnectionAgent().GetChannelCountInfo(serviceName, channelId, (ConnectionAgent connection, ResultCodeChannelCountInfo result, ChannelCountInfo channelCountInfo) => {
    /// <param name="result">GetChanneCountlInfo의 결과</param>
    /// <param name="channelCountInfo">채널의 유저,방 개수 정보</param>
	if(result == ResultCodeChannelCountInfo.CHANNEL_COUNT_INFO_SUCCESS){
		// 채널 카운트 정보 요청 성공
	} else {
		// 채널 카운트 정보 요청 실패
	}
});
```

GetChannelInfo()는 특정 채널의 정보(사용자 정의)를 요청하여 받아올 수 있습니다. 

```c#
/// <param name="serviceName">채널 정보를 요청할 서비스의 serviceName.</param>
/// <param name="channelId">채널 정보를 요청할 채널의 ChannelId.</param>
/// <param name="onChannelCountInfo">결과를 전달 받을 delegate.</param>
connector.GetConnectionAgent().GetChannelInfo(serviceName, channelId, (ConnectionAgent connection, ResultCodeChannelInfo result, Payload payload) => {
    /// <param name="result">GetChannelInfo의 결과</param>
    /// <param name="channelInfo">채널 정보</param>
	if(result == ResultCodeChannelInfo.CHANNEL_INFO_SUCCESS){
		// 채널 정보 요청 성공
	} else {
		// 채널 정보 요청 실패
	}
});
```

GetAllChannelCountInfo()는 특정 서비스의 모든 채널에 대한 카운트 정보(유저와 방 개수)를 요청하여 받아올 수 있습니다. 

```c#
/// <param name="serviceName">채널 정보를 요청할 서비스의 serviceName.</param>
/// <param name="onAllChannelCountInfo">결과를 전달 받을 delegate.</param>
connector.GeConnectionAgent().GetAllChannelCountInfo(serviceName, (ConnectionAgent connection, ResultCodeAllChannelCountInfo result, Dictionary<string, ChannelCountInfo> channelCountInfo) => {
    /// <param name="result">GetAllChannelCountInfo의 결과</param>
    /// <param name="channelCountInfo">채널의 유저,방 개수 정보 목록</param>
	if(result == ResultCodeAllChannelCountInfo.ALL_CHANNEL_COUNT_INFO_SUCCESS){
		// 모든 채널 카운트 정보 요청 성공
	} else {
		// 모든 채널 카운트 정보 요청 실패
	}
});
```

GetAllChannelInfo()는 특정 서비스의 모든 채널에 대한 정보(사용자 정의)를 요청하여 받아올 수 있습니다. 

```c#
/// <param name="serviceName">채널 정보를 요청할 서비스의 serviceName.</param>
/// <param name="onAllChannelInfo">결과를 전달 받을 delegate.</param>
connector.GetConnectionAgent().GetAllChannelInfo(serviceName, (ConnectionAgent connection, ResultCodeAllChannelInfo result, Dictionary<string, Payload> payload) => {
    /// <param name="result">GetAllChannelInfo의 결과</param>
    /// <param name="channelInfo">채널 정보 목록</param>
	if(result == ResultCodeAllChannelInfo.ALL_CHANNEL_INFO_SUCCESS){
		// 모든 채널 정보 요청 성공
	} else {
		// 모든 채널 정보 요청 실패
	}
});
```

### 접속 종료

ConnectionAgent의 Disconnect 함수를 이용해 서버와의 접속을 종료합니다. 

```c#
/// <param name="onDisconnect">결과를 전달 받을 delegate</param>
connector.GetConnectionAgent().Disconnect((ConnectionAgent connectionAgent, ResultCodeDisconnect result) => {
    /// <param name="result">Disconnect의 결과 또는 또는 강제 접속종료 알림</param>
    if (result == ResultCodeDisconnect.SOCKET_DISCONNECT) {
		// 정상 종료
    } else {
	    // 비정상 종료
    }
});
```

### Listener

ConnectionAgent에는 모든 동작의 결과 또는 알림을 받을 수 있도록 각각의 delegate를 맴버로 가지고 있습니다. 이 delegate에 함수를 등록하면 앞서 설명한 API에 콜백 인자를 생략하고 호출했을 경우 또는 서버에서 일림을 보냈을 경우 등록한 함수로 응답을 받을 수 있습니다.  

```c#
/// <summary>
/// Connect의 결과
/// </summary>
/// <param name="connectionAgent">ConnectionAgent</param>
/// <param name="result">Connect의 결과</param>
public Interface.DelConnectionOnConnect onConnectListeners;

/// <summary>
/// Authentication의 결과
/// </summary>
/// <param name="connectionAgent">ConnectionAgent</param>
/// <param name="result">Authentication의 결과</param>
/// <param name="loginedUserInfoList">서버에 남아있는 로그인 정보 목록</param>
/// <param name="message">서버로부터 받은 Message. 인증 실패 이유 등.</param>
/// <param name="payload">추가 정보</param>
public Interface.DelConnectionOnAuthentication onAuthenticationListeners;

/// <summary>
/// GetChannelList의 결과
/// </summary>
/// <param name="connectionAgent">ConnectionAgent</param>
/// <param name="result">GetChannelList의 결과</param>
/// <param name="channelIdList">채널 목록</param>
public Interface.DelConnectionOnChannelList onChannelListListeners;

/// <summary>
/// GetChannelInfo의 결과
/// </summary>
/// <param name="connectionAgent">ConnectionAgent</param>
/// <param name="result">GetChannelInfo의 결과</param>
/// <param name="channelInfo">채널 정보</param>
public Interface.DelConnectionOnChannelInfo onChannelInfoListeners;

/// <summary>
/// GetAllChannelInfo의 결과
/// </summary>
/// <param name="connectionAgent">ConnectionAgent</param>
/// <param name="result">GetAllChannelInfo의 결과</param>
/// <param name="channelInfo">채널 정보 목록</param>
public Interface.DelConnectionOnAllChannelInfo onAllChannelInfoListeners;

/// <summary>
/// GetChannelCountInfo의 결과
/// </summary>
/// <param name="connectionAgent">ConnectionAgent</param>
/// <param name="result">GetChanneCountlInfo의 결과</param>
/// <param name="channelCountInfo">채널의 유저,방 개수 정보</param>
public Interface.DelConnectionOnChannelCountInfo onChannelCountInfoListeners;

/// <summary>
/// GetAllChannelCountInfo의 결과
/// </summary>
/// <param name="connectionAgent">ConnectionAgent</param>
/// <param name="result">GetAllChannelCountInfo의 결과</param>
/// <param name="channelCountInfo">채널의 유저,방 개수 정보 목록</param>
public Interface.DelConnectionOnAllChannelCountInfo onAllChannelCountInfoListeners;

/// <summary>
/// Disconnect의 결과 또는 또는 강제 접속종료 알림
/// </summary>
/// <param name="connectionAgent">ConnectionAgent</param>
/// <param name="result">Disconnect의 결과 또는 또는 강제 접속종료 알림</param>
/// <param name="force">강제 종료 여부</param>
/// <param name="payload">추가 정보</param>
public Interface.DelConnectionOnDisconnect onDisconnectListeners;

/// <summary>
/// 기본 기능 사용중 Error발생
/// </summary>
/// <param name="connectionAgent">ConnectionAgent</param>
/// <param name="errorCode">에러 코드</param>
/// <param name="commands">에러가 발생한 기능</param>
public Interface.DelConnectionOnErrorCommand onErrorCommandListeners;

/// <summary>
/// Request, Send 전송후 Error발생
/// </summary>
/// <param name="connectionAgent">ConnectionAgent</param>
/// <param name="errorCode">에러 코드</param>
/// <param name="command">에러가 발생한 패킷의 MessageName</param>
public Interface.DelConnectionOnErrorCustomCommand onErrorCustomCommandListeners;
```

IConnectionListener는 ConnectionAgent의 모든 동작의 결과 또는 알림을 정의한 인터페이스입니다. 이 인터페이스를 구현한 리스너를 ConnectionAgent.AddConnectionListener()로 등록하면 등록한 리스너로 응답을 받을 수 있습니다. 

```c#
public class ConnectionListener : IConnectionListener
{
    /// <summary>
    /// Connect의 결과
    /// </summary>
    /// <param name="connectionAgent">ConnectionAgent</param>
    /// <param name="result">Connect의 결과</param>
    public void OnConnect(ConnectionAgent connectionAgent, ResultCodeConnect result) { }
    
    /// <summary>
    /// Authentication의 결과
    /// </summary>
    /// <param name="connectionAgent">ConnectionAgent</param>
    /// <param name="result">Authentication의 결과</param>
    /// <param name="loginedUserInfoList">서버에 남아있는 로그인 정보 목록</param>
    /// <param name="message">서버로부터 받은 Message. 인증 실패 이유 등.</param>
    /// <param name="payload">추가 정보</param>
    public void OnAuthentication(ConnectionAgent connectionAgent, ResultCodeAuth result, List<ConnectionAgent.LoginedUserInfo> loginedUserInfoList, string message, Payload payload) { }

    /// <summary>
    /// GetChannelList의 결과
    /// </summary>
    /// <param name="connectionAgent">ConnectionAgent</param>
    /// <param name="result">GetChannelList의 결과</param>
    /// <param name="channelIdList">채널 목록</param>
    public void OnChannelList(ConnectionAgent connectionAgent, ResultCodeChannelList result, List<string> channelIdList) { }

    /// <summary>
    /// GetChannelInfo의 결과
    /// </summary>
    /// <param name="connectionAgent">ConnectionAgent</param>
    /// <param name="result">GetChannelInfo의 결과</param>
    /// <param name="channelInfo">채널 정보</param>
    public void OnChannelInfo(ConnectionAgent connectionAgent, ResultCodeChannelInfo result, Payload channelInfo) { }

    /// <summary>
    /// GetAllChannelInfo의 결과
    /// </summary>
    /// <param name="connectionAgent">ConnectionAgent</param>
    /// <param name="result">GetChannelInfo의 결과</param>
    /// <param name="channelInfo">채널 정보 목록</param>
    public void OnAllChannelInfo(ConnectionAgent connectionAgent, ResultCodeAllChannelInfo result, Dictionary<string, Payload> channelInfo) { }

    /// <summary>
    /// GetChannelCountInfo의 결과
    /// </summary>
    /// <param name="connectionAgent">ConnectionAgent</param>
    /// <param name="result">GetChannelInfo의 결과</param>
    /// <param name="channelCountInfo">채널의 유저,방 개수 정보</param>
    public void OnChannelCountInfo(ConnectionAgent connectionAgent, ResultCodeChannelCountInfo result, ChannelCountInfo channelCountInfo) { }

	/// <summary>
    /// GetAllChannelCountInfo의 결과
    /// </summary>
    /// <param name="connectionAgent">ConnectionAgent</param>
    /// <param name="result">GetAllChannelCountInfo의 결과</param>
    /// <param name="channelCountInfo">채널의 유저,방 개수 정보 목록</param>
    public void OnAllChannelCountInfo(ConnectionAgent connectionAgent, ResultCodeAllChannelCountInfo result, Dictionary<string, ChannelCountInfo> channelCountInfo) { }
    
    /// <summary>
    /// Disconnect의 결과 또는 또는 강제 접속종료 알림
    /// </summary>
    /// <param name="connectionAgent">ConnectionAgent</param>
    /// <param name="result">Disconnect의 결과 또는 또는 강제 접속종료 알림</param>
    /// <param name="force">강제 종료 여부</param>
    /// <param name="payload">추가 정보</param>
    public void OnDisconnect(ConnectionAgent connectionAgent, ResultCodeDisconnect result, bool force, Payload payload) { }
    
    /// <summary>
    /// 기본 기능 사용중 Error발생
    /// </summary>
    /// <param name="connectionAgent">ConnectionAgent</param>
    /// <param name="errorCode">에러 코드</param>
    /// <param name="commands">에러가 발생한 기능</param>
    public void OnError(ConnectionAgent connectionAgent, ErrorCode errorCode, Commands commands) { }
    
    /// <summary>
    /// Request, Send 전송후 Error발생
    /// </summary>
    /// <param name="connectionAgent">ConnectionAgent</param>
    /// <param name="errorCode">에러 코드</param>
    /// <param name="command">에러가 발생한 패킷의 MessageName</param>
    public void OnError(ConnectionAgent connectionAgent, ErrorCode errorCode, string command) { }
}

connector.GetConnectionAgent().AddConnectionListener(new ConnectionListener);
```

